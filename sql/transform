CREATE TABLE jobs_salary AS
SELECT
    j.*,

	ROUND(
		CASE
	        WHEN j.salary LIKE '% - %'
	            THEN REPLACE(SPLIT_PART(j.salary, ' - ', 1), ',', '')::NUMERIC
	        WHEN j.salary LIKE 'Trên%'
	            THEN REPLACE(SPLIT_PART(j.salary, ' ', 2), ',', '')::NUMERIC
	        ELSE NULL
    	END
	, 0) AS min_salary,

	ROUND(
		CASE
	        WHEN j.salary LIKE '% - %'
	            THEN REPLACE(SPLIT_PART(SPLIT_PART(j.salary, ' - ', 2), ' ', 1), ',', '')::NUMERIC
	        WHEN j.salary LIKE 'Tới%'
	            THEN REPLACE(SPLIT_PART(j.salary, ' ', 2), ',', '')::NUMERIC
	        ELSE NULL
	    END
	, 0) AS max_salary,

    CASE
        WHEN j.salary = 'Thỏa thuận' THEN NULL
        WHEN j.salary ILIKE '%usd%' OR j.salary ILIKE '%$%' THEN 'USD'
        ELSE 'VND'
    END AS salary_unit
FROM jobs_raw j;

UPDATE jobs_salary
SET
    min_salary = min_salary * 1000000,
    max_salary = max_salary * 1000000
WHERE salary_unit = 'VND';

CREATE TABLE jobs_location AS
SELECT
    j.created_date,
    j.job_title,
    j.company,
    j.salary,
    j.min_salary,
    j.max_salary,
    j.salary_unit,
    j.time,
    j.link_description,

    trim(parts[idx])      AS city,
    trim(parts[idx + 1])  AS district

FROM jobs_salary j
CROSS JOIN LATERAL (
    SELECT string_to_array(j.address, ':') AS parts
) a
CROSS JOIN LATERAL (
    SELECT generate_series(1, array_length(a.parts, 1), 2) AS idx
) s;

DROP TABLE IF EXISTS jobs_transformed;

CREATE TABLE jobs_transformed AS
SELECT
    j.created_date,
	
    COALESCE(m.job_group, 'Other') AS job_group,
	
    j.job_title,
    j.company,

    j.salary,
    j.min_salary,
    j.max_salary,
    j.salary_unit,

    j.city,
    j.district,

    j.time,
    j.link_description

FROM jobs_location j
LEFT JOIN job_title_mapping m
    ON LOWER(j.job_title) LIKE '%' || m.keyword || '%';

DROP TABLE jobs_salary, jobs_location;