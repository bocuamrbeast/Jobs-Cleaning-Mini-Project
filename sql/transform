CREATE TABLE jobs_salary AS
SELECT
    j.*,

	ROUND(
		CASE
	        WHEN j.salary LIKE '% - %'
	            THEN REPLACE(SPLIT_PART(j.salary, ' - ', 1), ',', '')::NUMERIC
	        WHEN j.salary LIKE 'Trên%'
	            THEN REPLACE(SPLIT_PART(j.salary, ' ', 2), ',', '')::NUMERIC
	        ELSE NULL
    	END
	, 0) AS min_salary,

	ROUND(
		CASE
	        WHEN j.salary LIKE '% - %'
	            THEN REPLACE(SPLIT_PART(SPLIT_PART(j.salary, ' - ', 2), ' ', 1), ',', '')::NUMERIC
	        WHEN j.salary LIKE 'Tới%'
	            THEN REPLACE(SPLIT_PART(j.salary, ' ', 2), ',', '')::NUMERIC
	        ELSE NULL
	    END
	, 0) AS max_salary,

    CASE
        WHEN j.salary = 'Thỏa thuận' THEN NULL
        WHEN j.salary ILIKE '%usd%' OR j.salary ILIKE '%$%' THEN 'USD'
        ELSE 'VND'
    END AS salary_unit
FROM jobs_raw j;

UPDATE jobs_salary
SET
    min_salary = min_salary * 1000000,
    max_salary = max_salary * 1000000
WHERE salary_unit = 'VND';

UPDATE jobs_salary
SET
    salary_unit = 'VND'
WHERE min_salary > 1000000 OR max_salary > 1000000;

CREATE TABLE jobs_location AS
WITH split_parts AS (
    SELECT
        j.*,
        string_to_array(address, ':') AS parts
    FROM jobs_salary j
),
indexed_parts AS (
    SELECT
        s.*,
        trim(p.part) AS current_val,
        p.idx
    FROM split_parts s
    CROSS JOIN LATERAL unnest(s.parts) WITH ORDINALITY AS p(part, idx)
)
SELECT
    i.created_date, i.job_title, i.company, i.salary,
    i.min_salary, i.max_salary, i.salary_unit,
    i.time, i.link_description, i.address,
    i.current_val AS city,
    CASE
        WHEN trim(i.parts[i.idx + 1]) NOT IN (SELECT province_name FROM vn_provinces)
        THEN trim(i.parts[i.idx + 1])
        ELSE NULL
    END AS district
FROM indexed_parts i
WHERE i.current_val IN (SELECT province_name FROM vn_provinces);

DROP TABLE IF EXISTS jobs_transformed;

CREATE TABLE jobs_transformed AS
SELECT
    j.created_date,

    COALESCE(m.job_group, 'Other') AS job_group,

    j.job_title,
    j.company,

    j.salary,
    j.min_salary,
    j.max_salary,
    j.salary_unit,

    j.city,
    j.district,

    j.time,
    j.link_description

FROM jobs_location j
LEFT JOIN job_title_mapping m
    ON LOWER(j.job_title) LIKE '%' || m.keyword || '%';

DROP TABLE jobs_salary, jobs_location;